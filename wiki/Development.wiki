#summary HOWTO for developers
#labels Phase-Implementation,Deprecated

= Introduction =

This file is HOWTO for XMPP dissector developers. Before reading this doc you should be familiar with Wireshark README files, especialy README.developer and README.plugins.

== How XMPP dissector displays packets ==

Packet that looks like:
{{{
<iq
    from='marok.test@gmail.com/gmail.9EB5BC18'
    to='marok@marook.dyndns.org/c92ed70a'
    type='set'
    id='90E8492345BCC05E'>
    <jin:jingle
        action='session-initiate'
        sid='c1448747008' initiator='marok.test@gmail.com/gmail.9EB5BC18'
        xmlns:jin='urn:xmpp:jingle:1'>
        <jin:content
            name='video'
            creator='initiator'>
            <rtp:description media='video' xmlns:rtp='urn:xmpp:jingle:apps:rtp:1'>
                <rtp:payload-type id='99' name='H264-SVC'>
                    ...
                </rtp:payload-type>              
            </rtp:description>
            <p:transport xmlns:p='http://www.google.com/transport/p2p'/>
        </jin:content>
    </jin:jingle>
</iq>
}}}
is displayed by Wireshark like in the screenshoot:

[http://dl.dropbox.com/u/4436801/wireshark_xmpp/ws_zrzut.png]

Areas marked in the picture above means:
  # element name - jingle
  # namespace abbreviation - jin
  # important arguments
  # all arguments

= Files structure =

XMPP dissector is written as a plugin. Hence all files related to this dissector are stored in plugins/xmpp directory.

Files and their content:
  * packet-xmpp.c _(main file of the XMPP dissector)_
    * header fields (hf`_``*`) and subtree ids (ett`_``*`) initializations
    * XMPP_PORT
    * dissect_xmpp, proto_reg_handoff_xmpp, proto_register_xmpp - characteristic functions for each dissector
  * packet-xmpp.h
    * header fields (hf`_``*`) and subtree ids (ett`_``*`) exports
    * ETT_UNKNOWN_LEN - it describes depth of tree for unknown elements. If depth of tree for unknown element is higher than ETT_UNKNOWN_LEN then packet is set as malformed. In this case it should be increased.
  * xmpp-utils.c
    * functions responsible for: getting data from XML dissector, displaying them into protocol tree, managing memory
  * xmpp-`*`.c
    * functions that process specific elements

= Develope custom type of packet =

== Skeleton code ==

Each function that processes the part of XMPP packet should return void and have 4 parameters: proto_tree, tvbuff_t, packet_info and element_t.
{{{
void xmpp_foo(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, element_t *element)
}}}

Standard proto`_`tree and proto`_`item declaration.
{{{
proto_item *foo_item;
proto_tree *foo_tree;
}}}

Below we can see declaration of attributes and elements which will be searched in _element_.
_attr_info_ structure consists of attribute name, header field, boolean value describing that the attribute is required, another bool making that the attribute is displayed in area no. 3 (important attributes), pointer to the validation function and pointer to the data passing to this function.
_elem_info_ structure consists of a way of searching an element, data required to looking for an element, function that will process found element, number of possible occurences of an element.
{{{
attr_info attrs_info[] = {
    {"attr1", hf_xmpp_foo_attr, TRUE, TRUE, NULL, NULL},
    {"attr2", -1, FALSE, TRUE, NULL, NULL},
};
elem_info elems_info[] = {
    {NAME, "bar", xmpp_foo_bar, MANY},
};
}}}

Standard proto`_`tree and proto`_`item initialization.
{{{
foo_item = proto_tree_add_item(tree, hf_xmpp_foo, tvb, element->offset, element->length, TRUE);
foo_tree = proto_item_add_subtree(foo_item,ett_xmpp_foo);
}}}

Calling functions that display attributes and elements in tree using _attr_info_ array and _elem_info_ array. If _display_elems_ doesn't call then function _xmpp_unknown_ must be called.
{{{
display_attrs(foo_tree, element, pinfo, tvb, attrs_info, array_length(attrs_info));
display_elems(foo_tree, element, pinfo, tvb, elems_info, array_length(elems_info));
}}}
== Example ==
Let's take an example of the [http://xmpp.org/schemas/roster.xsd roster packet].

TODO